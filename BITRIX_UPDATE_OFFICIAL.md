# Официальное обновление Bitrix24: Новые задачи

## Текст обновления

> **Новые задачи — просто космос!**
> 
> **Аудио Задачи AI** — слова превращаются в действия
> - Отправьте голосовое сообщение в чат — AI сам поймёт, о чём идёт речь, создаст задачу и заполнит все нужные поля
> 
> **Чат теперь находится прямо в задаче**
> - В чате вы можете обсуждать детали, созваниваться, обмениваться файлами и отслеживать все изменения
> 
> **Листайте задачи как сообщения в мессенджере**
> - Читайте новые сообщения и отвечайте на них прямо в чате — быстро и привычно

## Ключевые изменения

### 1. Чат в задаче

**Что изменилось:**
- Каждая задача теперь имеет свой чат
- Чат находится прямо в интерфейсе задачи
- Все обсуждения задачи происходят в чате

**Технические детали:**
- В данных задачи появилось поле `chatId` (например, `43835`)
- Чат создается автоматически при создании задачи
- Чат нельзя отключить (обязательная функция)

### 2. Комментарии = Сообщения в чате

**Что изменилось:**
- Комментарии к задачам теперь являются сообщениями в чате задачи
- Нет отдельной системы комментариев
- Все взаимодействие происходит через чат

**Технические детали:**
- Метод `tasks.task.comment.get` удален из API
- В вебхуках `ID` комментария всегда равен `"0"`
- Реальный ID комментария находится в `MESSAGE_ID` (ID сообщения в чате)
- Нужно использовать `im.message.get` для получения комментариев

### 3. Задачи как сообщения

**Что изменилось:**
- Задачи можно листать как сообщения в мессенджере
- Интерфейс задач стал похож на интерфейс мессенджера
- Улучшена навигация между задачами

### 4. AI-задачи из голосовых сообщений

**Что изменилось:**
- Добавлена функция создания задач из голосовых сообщений
- AI анализирует голосовое сообщение и создает задачу
- Автоматически заполняются поля задачи

**Технические детали:**
- Вероятно, используется новый метод API для создания задач из сообщений
- Может быть связано с событиями `ONIMMESSAGEADD` в чатах

## Влияние на наш код

### Что нужно изменить

1. **Получение комментариев**
   - ❌ Убрать использование `tasks.task.comment.get`
   - ✅ Использовать `im.message.get` с `CHAT_ID` задачи

2. **Обработка вебхуков**
   - ✅ Использовать `MESSAGE_ID` вместо `ID` (уже исправлено)
   - ✅ Обрабатывать `chatId` из данных задачи

3. **Отправка уведомлений**
   - Можно отправлять уведомления в чат Bitrix24 (если есть доступ)
   - Или продолжать отправлять в Telegram группу

4. **Создание задач**
   - Возможно, добавить поддержку создания задач из голосовых сообщений
   - Интеграция с AI-функцией (если доступна через API)

## API методы для работы с чатами задач

### Получение сообщений из чата задачи

```python
# Получить конкретное сообщение (комментарий)
result = bitrix_client._make_request("im.message.get", {
    "ID": message_id,  # MESSAGE_ID из вебхука
    "CHAT_ID": chat_id  # chatId из задачи
})

# Получить последние сообщения из чата задачи
result = bitrix_client._make_request("im.message.get", {
    "CHAT_ID": chat_id,
    "LIMIT": 50
})
```

### Получение информации о чате задачи

```python
# Получить информацию о чате
result = bitrix_client._make_request("im.chat.get", {
    "CHAT_ID": chat_id
})
```

### Отправка сообщения в чат задачи

```python
# Отправить сообщение в чат задачи
result = bitrix_client._make_request("im.message.add", {
    "CHAT_ID": chat_id,
    "MESSAGE": "Текст сообщения"
})
```

## События вебхуков

### События задач (не изменились)

- `ONTASKADD` - создание задачи
- `ONTASKUPDATE` - обновление задачи
- `ONTASKDELETE` - удаление задачи

### События комментариев (изменились)

- `ONTASKCOMMENTADD` - теперь это добавление сообщения в чат задачи
  - `ID` всегда `"0"`
  - `MESSAGE_ID` - реальный ID сообщения
  - `TASK_ID` - ID задачи

### Новые события (возможно)

- `ONIMMESSAGEADD` - добавление сообщения в чат (может быть связано с задачами)
- `ONIMCHATADD` - создание чата (может быть связано с созданием задачи)

## Рекомендации

### Немедленные действия

1. ✅ Исправить использование `MESSAGE_ID` вместо `ID` (уже сделано)
2. ✅ Убрать попытки использовать `tasks.task.comment.get` (уже сделано)
3. ⏳ Добавить методы работы с чатами в `bitrix24_client.py`
4. ⏳ Обновить обработку комментариев для использования API чатов

### Дополнительные улучшения

1. Добавить поддержку отправки уведомлений в чат Bitrix24
2. Добавить обработку событий `ONIMMESSAGEADD` для отслеживания всех сообщений в чатах задач
3. Рассмотреть интеграцию с AI-функцией создания задач (если доступна через API)

## Полезные ссылки

- [Документация Bitrix24 REST API - Задачи](https://dev.1c-bitrix.ru/rest_help/tasks/index.php)
- [Документация Bitrix24 REST API - IM (Мессенджер)](https://dev.1c-bitrix.ru/rest_help/im/index.php)
- [Метод im.message.get](https://dev.1c-bitrix.ru/rest_help/im/im_message_get.php)
- [Метод im.message.add](https://dev.1c-bitrix.ru/rest_help/im/im_message_add.php)
- [Метод im.chat.get](https://dev.1c-bitrix.ru/rest_help/im/im_chat_get.php)
