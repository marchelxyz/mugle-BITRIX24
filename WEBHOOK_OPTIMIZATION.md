# Оптимизация обработки вебхуков Bitrix24

## Проблема

Исходящий вебхук Bitrix24 отправляет минимальные данные о событиях (например, для `ONTASKCOMMENTADD` передаются только `ID` комментария и `TASK_ID`). Это приводит к следующим проблемам:

1. **Недостаток информации**: Нет данных об авторе комментария, тексте комментария, создателе задачи, исполнителе
2. **Спам уведомлениями**: Уведомления отправляются всем, даже незарегистрированным пользователям
3. **Нет возможности тегать**: Нельзя упомянуть конкретных пользователей в уведомлениях

## Решение

Реализована оптимизированная обработка вебхуков:

1. **Получение полной информации через REST API**:
   - При получении вебхука создается временный `Bitrix24Client` с токеном из `auth.application_token`
   - Запрашивается полная информация о комментарии через `tasks.task.comment.get`
   - Запрашивается полная информация о задаче через `tasks.task.get` (создатель, исполнитель)

2. **Поиск зарегистрированных пользователей**:
   - Поиск Telegram ID через базу данных для создателя задачи, исполнителя и автора комментария
   - Используется функция `database.get_telegram_id_by_bitrix_id()` для обратного поиска

3. **Умная отправка уведомлений**:
   - Уведомления отправляются **только зарегистрированным пользователям**
   - Пользователи тегаются через `@username` или ссылку `tg://user?id=...`
   - Избегается спам для незарегистрированных пользователей

## Архитектура

```
Вебхук Bitrix24 (ONTASKCOMMENTADD)
    ↓
Извлечение данных: task_id, comment_id, auth.application_token
    ↓
Создание временного Bitrix24Client с токеном из вебхука
    ↓
Запрос полной информации через REST API:
    ├─ tasks.task.comment.get → автор, текст комментария
    └─ tasks.task.get → создатель, исполнитель, название задачи
    ↓
Поиск Telegram ID через базу данных:
    ├─ Создатель задачи → Telegram ID
    ├─ Исполнитель задачи → Telegram ID
    └─ Автор комментария → Telegram ID (если отличается)
    ↓
Отправка уведомления только зарегистрированным пользователям
```

## Изменения в коде

### 1. `bitrix24_client.py`

Добавлен метод `get_task_comment()`:

```python
def get_task_comment(self, task_id: int, comment_id: int) -> Optional[Dict]:
    """Получение комментария к задаче по ID"""
    result = self._make_request("tasks.task.comment.get", {
        "TASKID": task_id,
        "COMMENTID": comment_id
    })
    # ...
```

### 2. `database.py`

Добавлена функция `get_telegram_id_by_bitrix_id()`:

```python
def get_telegram_id_by_bitrix_id(bitrix_user_id: int) -> Optional[int]:
    """Получение Telegram ID по Bitrix24 User ID"""
    # Поиск в таблице telegram_to_bitrix
```

### 3. `task_notifications.py`

Обновлен метод `handle_task_comment_event()`:

- Принимает параметр `auth_data` с токеном из вебхука
- Создает временный `Bitrix24Client` с токеном из `auth.application_token`
- Запрашивает полную информацию о комментарии и задаче
- Ищет Telegram ID через базу данных
- Отправляет уведомления только зарегистрированным пользователям

### 4. `bot.py`

Обновлен вызов `handle_task_comment_event()`:

```python
auth_data = data.get('auth', {})
await task_notification_service.handle_task_comment_event(event, comment_data, auth_data)
```

## Преимущества

1. ✅ **Полная информация**: Получаем все необходимые данные о комментарии и задаче
2. ✅ **Нет спама**: Уведомления отправляются только зарегистрированным пользователям
3. ✅ **Теги пользователей**: Автоматическое упоминание создателя, исполнителя и автора комментария
4. ✅ **Использование токена из вебхука**: Не требуется дополнительная настройка токенов
5. ✅ **Обратная совместимость**: Если REST API недоступен, используется fallback через основной Bitrix24Client

## Пример работы

### Входящий вебхук:
```json
{
  "event": "ONTASKCOMMENTADD",
  "data": {
    "FIELDS_AFTER": {
      "ID": "338729",
      "TASK_ID": "40927"
    }
  },
  "auth": {
    "application_token": "wymqesv4swrosw46iixe94i4qbguoiy4",
    "domain": "muglerest.bitrix24.ru"
  }
}
```

### Обработка:
1. Создается временный `Bitrix24Client` с токеном `wymqesv4swrosw46iixe94i4qbguoiy4`
2. Запрашивается комментарий через `tasks.task.comment.get` → получаем автора и текст
3. Запрашивается задача через `tasks.task.get` → получаем создателя и исполнителя
4. Ищутся Telegram ID через базу данных:
   - Создатель задачи (ID 123) → Telegram ID 456789
   - Исполнитель задачи (ID 456) → Telegram ID 987654
   - Автор комментария (ID 789) → не зарегистрирован → пропускаем
5. Отправляется уведомление с тегами: `@user1, @user2, в задаче «Название задачи» новый комментарий: текст...`

## Настройка

Никаких дополнительных настроек не требуется. Система автоматически:

1. Использует токен из вебхука (`auth.application_token`)
2. Ищет зарегистрированных пользователей в базе данных
3. Отправляет уведомления только зарегистрированным пользователям

## Логирование

Система логирует все этапы обработки:

```
✅ Создан временный Bitrix24Client для получения полной информации через REST API
✅ Получена полная информация о комментарии 338729 через REST API
✅ Получена информация о задаче 40927: создатель=123, исполнитель=456
✅ Найден Telegram ID для создателя задачи: 456789
✅ Найден Telegram ID для исполнителя задачи: 987654
Автор комментария 789 не зарегистрирован в системе
✅ Отправлено уведомление о событии ONTASKCOMMENTADD для комментария 338729 к задаче 40927 (уведомлены: 2 пользователей)
```

## Обработка ошибок

- Если REST API недоступен → используется fallback через основной `Bitrix24Client`
- Если пользователь не зарегистрирован → пропускается (не отправляется уведомление)
- Если база данных недоступна → используется fallback через `Bitrix24Client.get_user_telegram_id()`

## Связанные документы

- [`WEBHOOK_DATA_STRUCTURE.md`](WEBHOOK_DATA_STRUCTURE.md) - структура данных вебхука
- [`BITRIX_OUTGOING_WEBHOOK.md`](BITRIX_OUTGOING_WEBHOOK.md) - настройка исходящего вебхука
- [`TASK_NOTIFICATIONS.md`](TASK_NOTIFICATIONS.md) - документация по уведомлениям
