# Система уведомлений о задачах

Система автоматических уведомлений о задачах в Telegram супергруппе для пользователей Bitrix24.

## Возможности

Система отслеживает задачи в Bitrix24 и отправляет уведомления в Telegram супергруппу в следующих случаях:

1. **Просроченные задачи** - когда срок выполнения задачи истек
2. **Приближающийся дедлайн** - когда до дедлайна остается определенное количество часов (по умолчанию 24 часа)
3. **Новые комментарии** - когда в задаче появляется новый комментарий

## Настройка

### 1. Получение ID Telegram супергруппы

Для работы системы уведомлений необходимо указать ID Telegram супергруппы, в которую будут отправляться уведомления.

**Способы получения ID группы:**

1. **Через бота @userinfobot:**
   - Добавьте бота @userinfobot в вашу супергруппу
   - Отправьте команду `/start` боту
   - Бот покажет ID группы (обычно начинается с `-100`)

2. **Через API Telegram:**
   - Используйте метод `getUpdates` или `getChat` для получения информации о чате
   - ID группы будет в поле `chat.id`

3. **Через веб-версию Telegram:**
   - Откройте группу в веб-версии Telegram
   - В URL будет ID группы

**Важно:** ID супергруппы обычно начинается с `-100` и является отрицательным числом.

### 2. Настройка переменных окружения

Добавьте следующие переменные в ваш `.env` файл или в настройки хостинга:

```env
# Обязательно: ID Telegram супергруппы для уведомлений
TELEGRAM_SUPERGROUP_ID=-1001234567890

# Опционально: Интервал проверки задач в минутах (по умолчанию 60 минут)
TASK_NOTIFICATION_CHECK_INTERVAL=60

# Опционально: За сколько часов до дедлайна отправлять предупреждение (по умолчанию 24 часа)
TASK_DEADLINE_WARNING_HOURS=24

# Опционально: Включить/выключить уведомления о просроченных задачах (по умолчанию true)
ENABLE_OVERDUE_NOTIFICATIONS=true

# Опционально: Включить/выключить предупреждения о приближающемся дедлайне (по умолчанию true)
ENABLE_DEADLINE_WARNINGS=true

# Опционально: Включить/выключить уведомления о новых комментариях (по умолчанию true)
ENABLE_COMMENT_NOTIFICATIONS=true
```

### 3. Связывание пользователей

Для того, чтобы система могла упоминать пользователей в уведомлениях, необходимо связать их Telegram аккаунты с аккаунтами Bitrix24.

Используйте команду `/link` в боте:

```
/link bitrix_user_id
```

Например:
```
/link 123
```

После связывания система будет автоматически упоминать пользователей в уведомлениях.

## Как это работает

### Просроченные задачи

Система периодически проверяет все задачи в Bitrix24 с просроченным дедлайном (DEADLINE < текущая дата) и статусом "не завершена".

Когда находится просроченная задача:
1. Система проверяет, не отправлялось ли уже уведомление об этой задаче
2. Получает Telegram ID ответственного пользователя из Bitrix24
3. Отправляет уведомление в супергруппу с упоминанием пользователя:
   ```
   [Пользователь], срок выполнения задачи «Название задачи» просрочен
   ```
4. Сохраняет информацию об отправленном уведомлении в БД

### Предупреждения о дедлайне

Система проверяет задачи с дедлайном в ближайшие N часов (по умолчанию 24 часа).

Когда находится задача с приближающимся дедлайном:
1. Система проверяет, не отправлялось ли уже уведомление
2. Вычисляет количество оставшихся часов до дедлайна
3. Отправляет уведомление:
   ```
   [Пользователь], срок выполнения задачи «Название задачи» истекает через X часов
   ```

### Уведомления о комментариях

Система проверяет новые комментарии в задачах за последний час.

Когда находится новый комментарий:
1. Система проверяет, не отправлялось ли уже уведомление об этом комментарии
2. Проверяет, что комментарий оставил не сам ответственный (чтобы не спамить)
3. Отправляет уведомление ответственному:
   ```
   [Пользователь], новый комментарий в задаче «Название задачи»: текст комментария...
   ```

## Формат уведомлений

Все уведомления отправляются в формате:
- **Упоминание пользователя** - кликабельная ссылка на пользователя Telegram
- **Текст уведомления** - описание события
- **Ссылка на задачу** - кликабельная ссылка на задачу в Bitrix24

Пример:
```
Иван Иванов, срок выполнения задачи «Подготовить отчет» просрочен
```

Где "Иван Иванов" - это кликабельная ссылка на пользователя, а "Подготовить отчет" - ссылка на задачу в Bitrix24.

## База данных

Система использует таблицу `task_notifications` в PostgreSQL для отслеживания отправленных уведомлений. Это предотвращает дублирование уведомлений.

Структура таблицы:
- `id` - уникальный идентификатор записи
- `notification_key` - уникальный ключ уведомления (task_id + type + extra)
- `task_id` - ID задачи в Bitrix24
- `notification_type` - тип уведомления (overdue, deadline_warning, comment)
- `sent_at` - время отправки уведомления
- `extra_data` - дополнительные данные (например, ID комментария)

## Отключение уведомлений

Для отключения определенных типов уведомлений установите соответствующие переменные окружения в `false`:

```env
ENABLE_OVERDUE_NOTIFICATIONS=false
ENABLE_DEADLINE_WARNINGS=false
ENABLE_COMMENT_NOTIFICATIONS=false
```

Для полного отключения системы уведомлений просто не указывайте `TELEGRAM_SUPERGROUP_ID`.

## Требования

- Telegram бот должен быть добавлен в супергруппу
- Бот должен иметь права на отправку сообщений в группу
- Пользователи должны быть связаны с Bitrix24 через команду `/link`
- Bitrix24 вебхук должен иметь права на чтение задач (`tasks.task.list`, `tasks.task.get`, `tasks.task.commentitem.getlist`)

## Устранение неполадок

### Уведомления не отправляются

1. Проверьте, что `TELEGRAM_SUPERGROUP_ID` установлен правильно
2. Убедитесь, что бот добавлен в супергруппу
3. Проверьте права бота на отправку сообщений
4. Проверьте логи бота на наличие ошибок

### Пользователи не упоминаются

1. Убедитесь, что пользователи связаны через команду `/link`
2. Проверьте, что в Bitrix24 сохранен Telegram ID пользователя
3. Убедитесь, что пользователь является членом супергруппы

### Дублирование уведомлений

1. Проверьте, что база данных работает корректно
2. Убедитесь, что таблица `task_notifications` создана
3. Проверьте логи на наличие ошибок при сохранении уведомлений

## Примеры использования

### Настройка для проверки каждые 30 минут

```env
TASK_NOTIFICATION_CHECK_INTERVAL=30
```

### Предупреждение за 12 часов до дедлайна

```env
TASK_DEADLINE_WARNING_HOURS=12
```

### Отключить уведомления о комментариях

```env
ENABLE_COMMENT_NOTIFICATIONS=false
```
