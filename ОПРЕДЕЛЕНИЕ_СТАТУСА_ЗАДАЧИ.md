# Определение статуса задачи без чтения комментариев

## Обзор

Система теперь определяет изменения в задачах (просрочена, изменены сроки сдачи, статус и т.д.) **без необходимости читать текст комментариев**. Это делается через анализ полей `FIELDS_BEFORE` и `FIELDS_AFTER` из вебхука `ONTASKUPDATE`.

## Как это работает

### 1. Событие ONTASKUPDATE

Когда задача изменяется в Bitrix24, отправляется вебхук с событием `ONTASKUPDATE`, который содержит:

```json
{
  "event": "ONTASKUPDATE",
  "data": {
    "FIELDS_BEFORE": {
      "ID": "123",
      "DEADLINE": "2024-01-15 18:00:00",
      "STATUS": "2",
      "RESPONSIBLE_ID": "456"
    },
    "FIELDS_AFTER": {
      "ID": "123",
      "DEADLINE": "2024-01-20 18:00:00",
      "STATUS": "3",
      "RESPONSIBLE_ID": "456"
    }
  }
}
```

### 2. Анализ изменений

Метод `_detect_task_changes()` сравнивает поля до и после изменения и определяет:

- ✅ **Изменение дедлайна** - сравнивает `DEADLINE` в `FIELDS_BEFORE` и `FIELDS_AFTER`
- ✅ **Просроченный дедлайн** - проверяет, стал ли новый дедлайн просроченным (меньше текущей даты)
- ✅ **Изменение статуса** - сравнивает `STATUS` и показывает название нового статуса
- ✅ **Изменение исполнителя** - сравнивает `RESPONSIBLE_ID`
- ✅ **Изменение названия** - сравнивает `TITLE`

### 3. Формирование уведомления

На основе обнаруженных изменений формируется детальное сообщение:

**Примеры уведомлений:**

- `⚠️ задача «Подготовить отчет»: дедлайн просрочен`
- `задача «Подготовить отчет»: изменен срок сдачи`
- `задача «Подготовить отчет»: статус изменен на "В работе"`
- `задача «Подготовить отчет»: изменен исполнитель`
- `задача «Подготовить отчет»: изменен срок сдачи, статус изменен на "Завершена"`

## Преимущества

### ✅ Не требует чтения комментариев

- Не нужно получать права на `im.message.get`
- Не нужно получать `chatId` задачи
- Работает быстрее (меньше API запросов)

### ✅ Точное определение изменений

- Определяет конкретные изменения (дедлайн, статус, исполнитель)
- Показывает, стал ли дедлайн просроченным
- Формирует понятные сообщения для пользователей

### ✅ Надежность

- Работает даже если у задачи нет `chatId`
- Не зависит от прав на чтение сообщений в чатах
- Работает для всех задач, включая старые

## Определяемые изменения

### 1. Дедлайн

**Определяется:**
- Изменение срока сдачи (`DEADLINE`)
- Просроченный дедлайн (новый дедлайн < текущая дата)
- Установка нового дедлайна (если раньше не было)

**Сообщения:**
- `дедлайн просрочен` - если новый дедлайн просрочен
- `изменен срок сдачи` - если дедлайн изменен, но не просрочен
- `установлен срок сдачи` - если дедлайн установлен впервые

### 2. Статус

**Определяется:**
- Изменение статуса задачи (`STATUS`)
- Показывается название нового статуса

**Сообщения:**
- `статус изменен на "В работе"` - с указанием нового статуса
- `статус изменен` - если статус не распознан

**Статусы:**
- `1` - Новая
- `2` - В работе
- `3` - Ожидает выполнения
- `4` - Требует внимания
- `5` - Завершена
- `6` - Отложена
- `7` - Отклонена

### 3. Исполнитель

**Определяется:**
- Изменение ответственного (`RESPONSIBLE_ID`)

**Сообщения:**
- `изменен исполнитель`

### 4. Название

**Определяется:**
- Изменение названия задачи (`TITLE`)

**Сообщения:**
- `изменено название`

## Обработка граничных случаев

### Нет FIELDS_BEFORE

Если `FIELDS_BEFORE` отсутствует (например, первое изменение задачи), система все равно может определить:
- Просроченный дедлайн (если текущий дедлайн просрочен)

### Нет FIELDS_AFTER

Если `FIELDS_AFTER` отсутствует, система не может определить изменения и использует общее сообщение об обновлении задачи.

### Несколько изменений одновременно

Если изменено несколько полей одновременно, все изменения перечисляются в сообщении:
```
задача «Название»: изменен срок сдачи, статус изменен на "Завершена"
```

## Технические детали

### Метод `_detect_task_changes()`

```python
def _detect_task_changes(
    fields_before: Optional[Dict], 
    fields_after: Optional[Dict]
) -> Dict[str, any]
```

**Возвращает:**
```python
{
    'deadline_changed': bool,
    'deadline_before': str или None,
    'deadline_after': str или None,
    'deadline_overdue': bool,
    'status_changed': bool,
    'status_before': str или None,
    'status_after': str или None,
    'responsible_changed': bool,
    'responsible_before': str или None,
    'responsible_after': str или None,
    'title_changed': bool,
    'changes': List[str]  # Список описаний изменений
}
```

### Обновленный метод `handle_task_event()`

Теперь принимает дополнительные параметры:
```python
async def handle_task_event(
    event: str, 
    task_data: Dict, 
    auth_data: Dict = None,
    fields_before: Optional[Dict] = None,
    fields_after: Optional[Dict] = None
)
```

## Примеры использования

### Пример 1: Изменение дедлайна

**Вебхук:**
```json
{
  "FIELDS_BEFORE": {"DEADLINE": "2024-01-15 18:00:00"},
  "FIELDS_AFTER": {"DEADLINE": "2024-01-20 18:00:00"}
}
```

**Результат:**
```
задача «Подготовить отчет»: изменен срок сдачи
```

### Пример 2: Просроченный дедлайн

**Вебхук:**
```json
{
  "FIELDS_BEFORE": {"DEADLINE": "2024-01-15 18:00:00"},
  "FIELDS_AFTER": {"DEADLINE": "2024-01-10 18:00:00"}  // Прошлая дата
}
```

**Результат:**
```
⚠️ задача «Подготовить отчет»: дедлайн просрочен
```

### Пример 3: Изменение статуса

**Вебхук:**
```json
{
  "FIELDS_BEFORE": {"STATUS": "2"},
  "FIELDS_AFTER": {"STATUS": "5"}
}
```

**Результат:**
```
задача «Подготовить отчет»: статус изменен на "Завершена"
```

### Пример 4: Несколько изменений

**Вебхук:**
```json
{
  "FIELDS_BEFORE": {
    "DEADLINE": "2024-01-15 18:00:00",
    "STATUS": "2"
  },
  "FIELDS_AFTER": {
    "DEADLINE": "2024-01-20 18:00:00",
    "STATUS": "5"
  }
}
```

**Результат:**
```
задача «Подготовить отчет»: изменен срок сдачи, статус изменен на "Завершена"
```

## Сравнение с предыдущим подходом

### Старый подход (через комментарии)

❌ Требовал:
- Права на `im.message.get`
- Получение `chatId` задачи
- Чтение текста комментария
- Парсинг текста для определения изменений

❌ Проблемы:
- Не работал для задач без `chatId`
- Требовал дополнительные права вебхука
- Медленнее (больше API запросов)
- Ненадежно (зависит от формата комментариев)

### Новый подход (через FIELDS_BEFORE/FIELDS_AFTER)

✅ Преимущества:
- Не требует дополнительных прав
- Работает для всех задач
- Быстрее (меньше API запросов)
- Надежнее (точные данные из вебхука)
- Определяет конкретные изменения

## Заключение

Новая система определения статуса задачи работает **без чтения комментариев** и определяет изменения напрямую из данных вебхука. Это делает систему более надежной, быстрой и простой в настройке.
