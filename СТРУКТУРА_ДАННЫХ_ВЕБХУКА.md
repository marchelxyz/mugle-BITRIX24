# Структура данных исходящего вебхука Bitrix24

## Общая структура вебхука

Все события от Bitrix24 приходят в следующем формате:

```json
{
  "event": "ТИП_СОБЫТИЯ",
  "event_handler_id": "ID_ОБРАБОТЧИКА",
  "data": {
    "FIELDS_BEFORE": {...},
    "FIELDS_AFTER": {...},
    "IS_ACCESSIBLE_BEFORE": null,
    "IS_ACCESSIBLE_AFTER": null
  },
  "ts": "TIMESTAMP",
  "auth": {
    "domain": "muglerest.bitrix24.ru",
    "client_endpoint": "https://muglerest.bitrix24.ru/rest/",
    "server_endpoint": "https://oauth.bitrix24.tech/rest/",
    "member_id": "9ab09aecc1e530d38fb4ee92714778a7",
    "application_token": "wymqesv4swrosw46iixe94i4qbguoiy4"
  }
}
```

## Поля верхнего уровня

- **`event`** (string) - Тип события (например, `ONTASKUPDATE`, `ONTASKCOMMENTADD`)
- **`event_handler_id`** (string) - ID обработчика события в Bitrix24
- **`ts`** (string) - Timestamp события (Unix timestamp в виде строки)
- **`data`** (object) - Данные события
- **`auth`** (object) - Данные авторизации для REST API запросов

## Данные авторизации (auth)

```json
{
  "domain": "muglerest.bitrix24.ru",
  "client_endpoint": "https://muglerest.bitrix24.ru/rest/",
  "server_endpoint": "https://oauth.bitrix24.tech/rest/",
  "member_id": "9ab09aecc1e530d38fb4ee92714778a7",
  "application_token": "wymqesv4swrosw46iixe94i4qbguoiy4"
}
```

Эти данные используются для выполнения REST API запросов к Bitrix24.

---

## Событие ONTASKUPDATE (обновление задачи)

### Структура данных

```json
{
  "event": "ONTASKUPDATE",
  "event_handler_id": "1191",
  "data": {
    "FIELDS_BEFORE": {
      "ID": "40931"
    },
    "FIELDS_AFTER": {
      "ID": "40931"
    },
    "IS_ACCESSIBLE_BEFORE": null,
    "IS_ACCESSIBLE_AFTER": null
  },
  "ts": "1765370136",
  "auth": {...}
}
```

### Важные особенности

1. **Минимальные данные в вебхуке**: В событии приходит только `ID` задачи
2. **Нет полей задачи**: В вебхуке НЕ приходят поля типа:
   - `CREATED_BY`
   - `RESPONSIBLE_ID`
   - `TITLE`
   - `DESCRIPTION`
   - `STATUS`
   - `DEADLINE`
   - и другие поля задачи

3. **Необходимость дополнительного запроса**: Для получения полной информации о задаче нужно делать REST API запрос:
   ```
   tasks.task.get с ID задачи
   ```

### Пример полных данных задачи (после REST API запроса)

После запроса `tasks.task.get` получаем:

```json
{
  "result": {
    "task": {
      "id": "40931",
      "title": "Ром на задачка",
      "description": "...",
      "createdBy": "1665",
      "createdDate": "2025-12-10T15:28:22+03:00",
      "responsibleId": "1665",
      "changedBy": "1665",
      "changedDate": "2025-12-10T15:35:36+03:00",
      "status": "...",
      "deadline": null,
      "priority": "1",
      "mark": null,
      "multitask": "N",
      "notViewed": "N",
      "replicate": "N",
      "stageId": "0",
      "sprintId": null,
      "backlogId": null,
      "commentsCount": "...",
      "serviceCommentsCount": "...",
      "groupId": "...",
      "auditors": [...],
      "accomplices": [...],
      "checklist": [...],
      "group": {...},
      "creator": {...},
      "responsible": {...},
      "accomplicesData": [...],
      "auditorsData": [...],
      "newCommentsCount": "...",
      "action": {...},
      "checkListTree": [...],
      "checkListCanAdd": true,
      // ... и много других полей
    }
  },
  "time": {...}
}
```

---

## Событие ONTASKCOMMENTADD (добавление комментария)

### Структура данных

```json
{
  "event": "ONTASKCOMMENTADD",
  "event_handler_id": "1195",
  "data": {
    "FIELDS_BEFORE": null,
    "FIELDS_AFTER": {
      "ID": "338769",
      "TASK_ID": "40931"
    },
    "IS_ACCESSIBLE_BEFORE": "N",
    "IS_ACCESSIBLE_AFTER": null
  },
  "ts": "1765370136",
  "auth": {...}
}
```

### Важные особенности

1. **Минимальные данные в вебхуке**: В событии приходят только:
   - `ID` - ID комментария
   - `TASK_ID` - ID задачи, к которой добавлен комментарий

2. **Нет полей комментария**: В вебхуке НЕ приходят поля типа:
   - `AUTHOR_ID` - ID автора комментария
   - `POST_MESSAGE` - Текст комментария
   - `POST_DATE` - Дата комментария
   - и другие поля комментария

3. **Проблема с REST API**: Метод `tasks.task.comment.get` возвращает ошибку:
   ```
   HTTP ошибка 400: 22002 - Could not find description of get in Bitrix\Tasks\Rest\Controllers\Task\Comment
   ```

4. **Альтернативный подход**: При невозможности получить комментарий, получаем информацию о задаче через `tasks.task.get` и используем данные задачи для уведомления.

---

## Сравнение данных в вебхуке и после REST API запроса

### Для задач (ONTASKUPDATE)

| Данные | В вебхуке | После REST API запроса |
|--------|-----------|------------------------|
| ID задачи | ✅ `"40931"` | ✅ `"40931"` |
| Название задачи | ❌ | ✅ `"Ром на задачка"` |
| Описание | ❌ | ✅ Полное описание |
| Создатель (CREATED_BY) | ❌ | ✅ `"1665"` |
| Исполнитель (RESPONSIBLE_ID) | ❌ | ✅ `"1665"` |
| Статус | ❌ | ✅ |
| Дедлайн | ❌ | ✅ |
| Приоритет | ❌ | ✅ `"1"` |
| Дата создания | ❌ | ✅ `"2025-12-10T15:28:22+03:00"` |
| Дата изменения | ❌ | ✅ `"2025-12-10T15:35:36+03:00"` |
| Комментарии | ❌ | ✅ Список комментариев |
| Участники | ❌ | ✅ Список участников |
| Чеклист | ❌ | ✅ Чеклист |

### Для комментариев (ONTASKCOMMENTADD)

| Данные | В вебхуке | После REST API запроса |
|--------|-----------|------------------------|
| ID комментария | ✅ `"338769"` | ❌ (ошибка API) |
| ID задачи | ✅ `"40931"` | ✅ |
| Автор комментария | ❌ | ❌ (ошибка API) |
| Текст комментария | ❌ | ❌ (ошибка API) |
| Дата комментария | ❌ | ❌ (ошибка API) |

---

## Выводы

1. **Вебхук содержит минимум данных**: Только ID задачи/комментария
2. **Необходимы REST API запросы**: Для получения полной информации нужно делать дополнительные запросы
3. **Используйте auth данные**: Данные из `auth` используются для авторизации REST API запросов
4. **Проблема с комментариями**: Метод `tasks.task.comment.get` не работает, нужно использовать альтернативные подходы
5. **FIELDS_BEFORE vs FIELDS_AFTER**:
   - `FIELDS_AFTER` - данные после изменения (для добавления/обновления)
   - `FIELDS_BEFORE` - данные до изменения (для удаления)

---

## Рекомендации по обработке

1. **Для задач**:
   - Извлечь `ID` из `FIELDS_AFTER` или `FIELDS_BEFORE`
   - Использовать `auth` данные для запроса `tasks.task.get`
   - Получить полную информацию о задаче
   - Извлечь `createdBy`, `responsibleId` и другие поля

2. **Для комментариев**:
   - Извлечь `TASK_ID` и `ID` комментария из `FIELDS_AFTER`
   - Попробовать получить комментарий через `tasks.task.comment.get` (может не работать)
   - Если не работает, получить информацию о задаче через `tasks.task.get`
   - Использовать данные задачи для уведомления

3. **Обработка ошибок**:
   - Всегда проверять наличие данных в `FIELDS_AFTER` и `FIELDS_BEFORE`
   - Обрабатывать случаи, когда REST API запросы не работают
   - Логировать все этапы обработки для отладки
