<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
        }
        
        h1 {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 8px;
            font-size: 15px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: inherit;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .user-select {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-select input {
            flex: 1;
        }
        
        .btn-change {
            padding: 8px 16px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .btn-change:active {
            opacity: 0.8;
        }
        
        .original-message {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .original-message-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 6px;
        }
        
        .btn-submit {
            width: 100%;
            padding: 14px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-submit:active:not(:disabled) {
            opacity: 0.8;
        }
        
        .error {
            color: #ff3333;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .loading.show {
            display: block;
        }
        
        .success {
            display: none;
            text-align: center;
            padding: 20px;
            color: #4caf50;
        }
        
        .success.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</h1>
        
        <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="error" class="error"></div>
        
        <form id="taskForm" style="display: none;">
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <input type="text" id="taskTitle" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
            </div>
            
            <div class="form-group">
                <label>–ü–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫</label>
                <div class="user-select">
                    <input type="text" id="creatorName" readonly>
                    <button type="button" class="btn-change" onclick="changeCreator()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
                <input type="hidden" id="creatorId">
            </div>
            
            <div class="form-group">
                <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                <div class="user-select">
                    <input type="text" id="responsibleName" readonly>
                    <button type="button" class="btn-change" onclick="changeResponsible()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
                <input type="hidden" id="responsibleId">
            </div>
            
            <div class="form-group">
                <label>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                <input type="datetime-local" id="deadline">
            </div>
            
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"></textarea>
            </div>
            
            <div class="form-group">
                <div class="original-message">
                    <div class="original-message-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</div>
                    <div id="originalMessage"></div>
                </div>
            </div>
            
            <button type="submit" class="btn-submit" id="submitBtn">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
        </form>
        
        <div id="success" class="success">
            ‚úÖ –ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!
        </div>
    </div>
    
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL
        // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –¥–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∞:
        // 1. –ü—Ä—è–º–æ–π URL: /miniapp?token=xxx
        // 2. Direct Link Mini App: –ø–∞—Ä–∞–º–µ—Ç—Ä tgWebAppStartParam (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ startapp)
        const urlParams = new URLSearchParams(window.location.search);
        let token = urlParams.get('token');
        
        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ token, –ø—Ä–æ–≤–µ—Ä—è–µ–º tgWebAppStartParam
        // –≠—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Direct Link Mini App —Ñ–æ—Ä–º–∞—Ç–∞
        // https://t.me/botusername?startapp=token
        if (!token) {
            token = urlParams.get('tgWebAppStartParam');
            // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ initData –æ—Ç Telegram WebApp API
            if (!token && tg.initData) {
                try {
                    const initDataParams = new URLSearchParams(tg.initData);
                    token = initDataParams.get('start_param');
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ initData:', e);
                }
            }
        }
        
        let sessionData = null;
        let usersList = [];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
        if (!token) {
            showError('–¢–æ–∫–µ–Ω —Å–µ—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞.');
            document.getElementById('loading').classList.remove('show');
            return;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
        async function loadSession() {
            try {
                const response = await fetch(`/api/miniapp/session?token=${token}`);
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏');
                }
                const data = await response.json();
                sessionData = data;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('creatorName').value = data.creator_name;
                document.getElementById('creatorId').value = data.creator_bitrix_id;
                
                // –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —É–∫–∞–∑–∞–Ω
                if (data.responsible_bitrix_id) {
                    document.getElementById('responsibleName').value = data.responsible_name;
                    document.getElementById('responsibleId').value = data.responsible_bitrix_id;
                } else {
                    document.getElementById('responsibleName').value = '–ù–µ –≤—ã–±—Ä–∞–Ω';
                    document.getElementById('responsibleId').value = '';
                }
                
                document.getElementById('originalMessage').textContent = data.original_message_text || '(–Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞)';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞
                await loadUsers();
                
                document.getElementById('loading').classList.remove('show');
                document.getElementById('taskForm').style.display = 'block';
            } catch (error) {
                showError(error.message);
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const response = await fetch('/api/miniapp/users');
                if (response.ok) {
                    usersList = await response.json();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            }
        }
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
        function changeCreator() {
            searchAndSelectUser('creator', '–ø–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞');
        }
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
        function changeResponsible() {
            searchAndSelectUser('responsible', '–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è');
        }
        
        // –ü–æ–∏—Å–∫ –∏ –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function searchAndSelectUser(type, label) {
            if (usersList.length === 0) {
                tg.showAlert('–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–µ—Ä–≤—ã–µ 20)
            const displayList = usersList.slice(0, 20);
            const userListText = displayList.map((u, idx) => `${idx + 1}. ${u.name} (ID: ${u.id})`).join('\n');
            const fullListText = usersList.length > 20 ? 
                userListText + `\n\n... –∏ –µ—â–µ ${usersList.length - 20} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π` : 
                userListText;
            
            tg.showPopup({
                title: `–í—ã–±–æ—Ä ${label}`,
                message: `–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-${displayList.length}), –∏–º—è –∏–ª–∏ ID:\n\n${fullListText}`,
                buttons: [{type: 'ok'}]
            }, () => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π prompt –¥–ª—è –≤–≤–æ–¥–∞
                const searchText = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä, –∏–º—è –∏–ª–∏ ID ${label}:`);
                if (!searchText) return;
                
                const searchLower = searchText.trim().toLowerCase();
                
                // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                let user = null;
                
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–º–µ—Ä
                const num = parseInt(searchText);
                if (!isNaN(num) && num > 0 && num <= displayList.length) {
                    user = displayList[num - 1];
                } else {
                    // –ò—â–µ–º –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID
                    user = usersList.find(u => 
                        u.name.toLowerCase().includes(searchLower) || 
                        u.id.toString() === searchText.trim()
                    );
                }
                
                if (user) {
                    if (type === 'creator') {
                        document.getElementById('creatorName').value = user.name;
                        document.getElementById('creatorId').value = user.id;
                    } else {
                        document.getElementById('responsibleName').value = user.name;
                        document.getElementById('responsibleId').value = user.id;
                    }
                    tg.showAlert(`‚úÖ –í—ã–±—Ä–∞–Ω ${label}: ${user.name}`);
                } else {
                    tg.showAlert(`‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.`);
                }
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
            
            const responsibleId = document.getElementById('responsibleId').value;
            if (!responsibleId) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è');
                submitBtn.disabled = false;
                submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É';
                return;
            }
            
            const formData = {
                token: token,
                title: document.getElementById('taskTitle').value,
                creator_id: parseInt(document.getElementById('creatorId').value),
                responsible_id: parseInt(responsibleId),
                deadline: document.getElementById('deadline').value,
                description: document.getElementById('description').value,
                original_message_text: sessionData.original_message_text
            };
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º deadline –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
            if (formData.deadline) {
                const date = new Date(formData.deadline);
                formData.deadline = date.toISOString().slice(0, 19).replace('T', ' ');
            }
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            if (formData.original_message_text) {
                if (formData.description) {
                    formData.description = formData.original_message_text + '\n\n' + formData.description;
                } else {
                    formData.description = formData.original_message_text;
                }
            }
            
            try {
                const response = await fetch('/api/miniapp/create-task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                }
                
                // –£—Å–ø–µ—Ö
                document.getElementById('taskForm').style.display = 'none';
                document.getElementById('success').classList.add('show');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º Mini App —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    tg.close();
                }, 2000);
                
            } catch (error) {
                showError(error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É';
            }
        });
        
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadSession();
    </script>
</body>
</html>
