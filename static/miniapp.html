<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Bitrix24 UI CSS -->
    <link rel="stylesheet" href="https://cdn.bitrix24.ru/b24/css/b24ui.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
        }
        
        h1 {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--tg-theme-text-color, #000000);
            font-weight: 600;
        }
        
        /* Bitrix24 UI —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å */
        .ui-form {
            margin-bottom: 16px;
        }
        
        .ui-form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 8px;
            font-size: 15px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
            box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.1);
        }
        
        input:disabled, textarea:disabled, select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .user-select {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-select input {
            flex: 1;
        }
        
        .btn-change {
            padding: 8px 16px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: opacity 0.2s, transform 0.1s;
            font-weight: 500;
        }
        
        .btn-change:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
        
        .btn-change:hover {
            opacity: 0.9;
        }
        
        .original-message {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--tg-theme-text-color, #000000);
            border-left: 3px solid var(--tg-theme-button-color, #3390ec);
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .original-message #originalMessage {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .original-message-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-submit {
            width: 100%;
            padding: 14px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: opacity 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(51, 144, 236, 0.2);
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-submit:active:not(:disabled) {
            opacity: 0.9;
            transform: translateY(1px);
            box-shadow: 0 1px 4px rgba(51, 144, 236, 0.2);
        }
        
        .btn-submit:hover:not(:disabled) {
            opacity: 0.95;
            box-shadow: 0 4px 12px rgba(51, 144, 236, 0.3);
        }
        
        .error {
            color: #ff3333;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .loading.show {
            display: block;
        }
        
        .success {
            display: none;
            text-align: center;
            padding: 20px;
            color: #4caf50;
        }
        
        .success.show {
            display: block;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
            max-height: 80vh;
            width: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .modal-search {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        
        .modal-search:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
        }
        
        .modal-users-list {
            flex: 1;
            overflow-y: auto;
            max-height: 50vh;
            margin-bottom: 16px;
        }
        
        .modal-user-item {
            padding: 12px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
            margin-bottom: 4px;
        }
        
        .modal-user-item:hover {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            transform: translateX(4px);
        }
        
        .modal-user-item:active {
            transform: scale(0.98);
        }
        
        .modal-user-item.selected {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        
        .modal-user-item .checkbox {
            margin-right: 8px;
            width: 20px;
            height: 20px;
            border: 2px solid var(--tg-theme-hint-color, #999999);
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .modal-user-item.selected .checkbox {
            background: var(--tg-theme-button-text-color, #ffffff);
            border-color: var(--tg-theme-button-text-color, #ffffff);
        }
        
        .modal-user-item .checkbox::after {
            content: '‚úì';
            color: var(--tg-theme-button-color, #3390ec);
            font-weight: bold;
            display: none;
        }
        
        .modal-user-item.selected .checkbox::after {
            display: block;
        }
        
        .modal-user-content {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .selected-users-list {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .selected-user-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 16px;
            font-size: 13px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .selected-user-tag .remove-btn {
            cursor: pointer;
            font-weight: bold;
            color: var(--tg-theme-hint-color, #999999);
            font-size: 16px;
            line-height: 1;
        }
        
        .selected-user-tag .remove-btn:hover {
            color: #ff3333;
            transform: scale(1.2);
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—à–∏–±–æ–∫ */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .loading::before {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid var(--tg-theme-hint-color, #e0e0e0);
            border-top-color: var(--tg-theme-button-color, #3390ec);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            padding: 12px;
            background: #fff3f3;
            border-left: 3px solid #ff3333;
            border-radius: 6px;
        }
        
        .success {
            padding: 20px;
            background: #f0fff4;
            border-left: 3px solid #4caf50;
            border-radius: 6px;
        }
        
        .modal-user-name {
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .modal-user-id {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 4px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 8px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .modal-btn-cancel {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }
        
        .modal-btn-cancel:active {
            opacity: 0.8;
        }
        
        .modal-btn-apply {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        
        .modal-btn-apply:active {
            opacity: 0.8;
        }
        
        .modal-btn-apply:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .deadline-shortcuts {
            margin-top: 8px;
        }
        
        .deadline-btn {
            padding: 6px 12px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .deadline-btn:hover {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-color: var(--tg-theme-button-color, #3390ec);
        }
        
        .deadline-btn:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</h1>
        
        <div id="loading" class="loading show">
            <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <div id="error" class="error"></div>
        
        <form id="taskForm" style="display: none;">
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <input type="text" id="taskTitle" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
            </div>
            
            <div class="form-group">
                <label>–ü–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫</label>
                <div class="user-select">
                    <input type="text" id="creatorName" readonly>
                    <button type="button" class="btn-change" onclick="changeCreator()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
                <input type="hidden" id="creatorId">
            </div>
            
            <div class="form-group">
                <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</label>
                <div class="user-select">
                    <input type="text" id="responsibleNames" readonly placeholder="–ù–µ –≤—ã–±—Ä–∞–Ω—ã">
                    <button type="button" class="btn-change" onclick="changeResponsible()">–í—ã–±—Ä–∞—Ç—å</button>
                </div>
                <div id="selectedResponsibles" class="selected-users-list"></div>
                <input type="hidden" id="responsibleIds">
            </div>
            
            <div class="form-group">
                <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <div class="user-select">
                    <select id="departmentSelect">
                        <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                    </select>
                    <button type="button" class="btn-change" onclick="loadDepartments()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <input type="hidden" id="departmentId">
            </div>
            
            <div class="form-group">
                <label>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–≤—Ä–µ–º—è —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –ú–°–ö)</label>
                <input type="datetime-local" id="deadline">
                <div class="deadline-shortcuts" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                    <button type="button" class="deadline-btn" onclick="setDeadlineShortcut(1)">–ß–µ—Ä–µ–∑ 1 –¥–µ–Ω—å</button>
                    <button type="button" class="deadline-btn" onclick="setDeadlineShortcut(3)">–ß–µ—Ä–µ–∑ 3 –¥–Ω—è</button>
                    <button type="button" class="deadline-btn" onclick="setDeadlineShortcut(7)">–ß–µ—Ä–µ–∑ 7 –¥–Ω–µ–π</button>
                    <button type="button" class="deadline-btn" onclick="setDeadlineShortcut(15)">–ß–µ—Ä–µ–∑ 15 –¥–Ω–µ–π</button>
                    <button type="button" class="deadline-btn" onclick="setDeadlineShortcut(30)">–ß–µ—Ä–µ–∑ –º–µ—Å—è—Ü</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"></textarea>
            </div>
            
            <div class="form-group">
                <div class="original-message">
                    <div class="original-message-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</div>
                    <div id="originalMessage"></div>
                </div>
            </div>
            
            <button type="submit" class="btn-submit" id="submitBtn">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
        </form>
        
        <div id="success" class="success">
            <div style="font-size: 18px; margin-bottom: 8px;">‚úÖ –ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</div>
            <div style="font-size: 14px; color: var(--tg-theme-hint-color, #666);">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥...</div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="userModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header" id="modalTitle">–í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <input type="text" id="modalSearch" class="modal-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID...">
            <div class="modal-users-list" id="modalUsersList"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeUserModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º —è–≤–Ω–æ
        // –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: https://core.telegram.org/bots/webapps
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é Mini App –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ,
        // –Ω–æ –º—ã —è–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
        // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º tg.expand() - —ç—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É viewport –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        // –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç Telegram –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞ –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ
        // –í –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ –≤—ã—Å–æ—Ç–∞ viewport –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞, –∏ –º—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ—ë —è–≤–Ω–æ
        if (typeof tg.viewportStableHeight !== 'undefined') {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –≤—ã—Å–æ—Ç—É viewport –∫–∞–∫ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
            tg.viewportStableHeight = window.innerHeight;
        }
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ
        // –í –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞
        // –∏ –Ω–µ –∑–∞–Ω–∏–º–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —á–µ—Ä–µ–∑ tg.expand())
        
        console.log('Mini App —Ä–µ–∂–∏–º:', tg.isExpanded ? '–ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π' : '–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π');
        console.log('Viewport –≤—ã—Å–æ—Ç–∞:', window.innerHeight);
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL
        // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç–æ–≤:
        // 1. –ü—Ä—è–º–æ–π URL: /miniapp?token=xxx
        // 2. Direct Link Mini App: –ø–∞—Ä–∞–º–µ—Ç—Ä start_param —á–µ—Ä–µ–∑ tg.initDataUnsafe.start_param
        // 3. –ß–µ—Ä–µ–∑ tgWebAppStartParam –≤ URL
        const urlParams = new URLSearchParams(window.location.search);
        let token = urlParams.get('token');
        
        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ token, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ Telegram WebApp API
        // –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è Direct Link Mini App —Ñ–æ—Ä–º–∞—Ç–∞: https://t.me/botusername?startapp=token
        if (!token) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ initDataUnsafe (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
            if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
                token = tg.initDataUnsafe.start_param;
            }
            // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ initData (—Å—Ç—Ä–æ–∫–∞)
            if (!token && tg.initData) {
                try {
                    const initDataParams = new URLSearchParams(tg.initData);
                    token = initDataParams.get('start_param');
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ initData:', e);
                }
            }
            // Fallback: –ø—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä tgWebAppStartParam
            if (!token) {
                token = urlParams.get('tgWebAppStartParam');
            }
        }
        
        console.log('–¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω:', token ? '–î–∞' : '–ù–µ—Ç', token ? `(–¥–ª–∏–Ω–∞: ${token.length})` : '');
        console.log('URL:', window.location.href);
        console.log('initDataUnsafe:', tg.initDataUnsafe);
        
        let sessionData = null;
        let usersList = [];
        let departmentsList = [];
        let selectedResponsibles = [];
        let selectedUsersInModal = new Set();
        
        // –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—ã–π URL –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
        function getApiUrl(path) {
            // –ï—Å–ª–∏ –ø—É—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –¥–æ–º–µ–Ω–∞
            // –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –ø—Ä—è–º–æ–≥–æ URL, –∏ –¥–ª—è Direct Link Mini App
            const baseUrl = window.location.origin;
            return `${baseUrl}${path}`;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
        async function loadSession() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('loading').classList.add('show');
            try {
                let response;
                
                // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                if (token) {
                    const apiUrl = getApiUrl(`/api/miniapp/session?token=${token}`);
                    response = await fetch(apiUrl);
                } else {
                    // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç, –ø–µ—Ä–µ–¥–∞–µ–º initData –∏–∑ Telegram WebApp API —á–µ—Ä–µ–∑ POST
                    // –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–≥–¥–∞ Mini App –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –º–µ–Ω—é
                    const initData = tg.initData;
                    if (!initData) {
                        throw new Error('–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É /create.');
                    }
                    
                    // –ü–µ—Ä–µ–¥–∞–µ–º initData —á–µ—Ä–µ–∑ POST –∑–∞–ø—Ä–æ—Å
                    const apiUrl = getApiUrl('/api/miniapp/session');
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ initData: initData })
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Bitrix24, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if (errorData.error_code === 'USER_NOT_LINKED') {
                        showError('–í–∞—à Telegram –∞–∫–∫–∞—É–Ω—Ç –Ω–µ —Å–≤—è–∑–∞–Ω —Å –ë–∏—Ç—Ä–∏–∫—Å24.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É:\n/link bitrix_user_id\n\n–ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Å–≤–æ–π ID –≤ –ë–∏—Ç—Ä–∏–∫—Å24, –∑–∞–π–¥–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤ URL.');
                        document.getElementById('loading').classList.remove('show');
                        return;
                    }
                    
                    throw new Error(errorData.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏');
                }
                const data = await response.json();
                console.log('–î–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data);
                sessionData = data;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('creatorName').value = data.creator_name || '';
                document.getElementById('creatorId').value = data.creator_bitrix_id || '';
                
                // –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ —É–∫–∞–∑–∞–Ω—ã
                selectedResponsibles = [];
                if (data.responsible_bitrix_id) {
                    selectedResponsibles = [{
                        id: data.responsible_bitrix_id,
                        name: data.responsible_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                    }];
                    updateResponsiblesDisplay();
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–¥–µ–ª, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                // –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∑–¥–µ—Å—å - –æ–Ω–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –Ω–∏–∂–µ
                if (data.department_id) {
                    document.getElementById('departmentId').value = data.department_id;
                    // –ó–Ω–∞—á–µ–Ω–∏–µ –≤ select —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
                }
                
                document.getElementById('originalMessage').textContent = data.original_message_text || '(–Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞)';
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –°–†–ê–ó–£ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏
                // –°–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –∑–∞–≥—Ä—É–∑–∏–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ —Ñ–æ–Ω–µ
                document.getElementById('loading').classList.remove('show');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('taskForm').style.display = 'block';
                console.log('–§–æ—Ä–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ —Ñ–æ–Ω–µ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã)
                Promise.all([
                    loadUsers(),
                    loadDepartments()
                ]).then(() => {
                    console.log('–°–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                }).catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–æ–≤:', error);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏:', error);
                document.getElementById('loading').classList.remove('show');
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const response = await fetch(getApiUrl('/api/miniapp/users'));
                if (response.ok) {
                    usersList = await response.json();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
        async function loadDepartments() {
            try {
                const response = await fetch(getApiUrl('/api/miniapp/departments'));
                if (response.ok) {
                    departmentsList = await response.json();
                    const departmentSelect = document.getElementById('departmentSelect');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–∏–∑ —Å–µ—Å—Å–∏–∏ –∏–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ)
                    const currentValue = document.getElementById('departmentId').value || departmentSelect.value;
                    
                    // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ "–ù–µ –≤—ã–±—Ä–∞–Ω–æ")
                    departmentSelect.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
                    departmentsList.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name;
                        departmentSelect.appendChild(option);
                    });
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–µ—Å—Å–∏–∏ –∏–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
                    if (currentValue) {
                        departmentSelect.value = currentValue;
                        document.getElementById('departmentId').value = currentValue;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π:', error);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è select –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π (–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
        // –¢–∞–∫ –∫–∞–∫ —Å–∫—Ä–∏–ø—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ body, DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–∑—É
        (function initDepartmentSelectHandler() {
            const departmentSelect = document.getElementById('departmentSelect');
            if (departmentSelect) {
                departmentSelect.addEventListener('change', function() {
                    document.getElementById('departmentId').value = this.value || '';
                });
            }
        })();
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
        function changeCreator() {
            searchAndSelectUser('creator', '–ø–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞');
        }
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
        function changeResponsible() {
            searchAndSelectUsers('responsible', '–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
        function updateResponsiblesDisplay() {
            const namesInput = document.getElementById('responsibleNames');
            const idsInput = document.getElementById('responsibleIds');
            const tagsContainer = document.getElementById('selectedResponsibles');
            
            if (selectedResponsibles.length === 0) {
                namesInput.value = '';
                idsInput.value = '';
                tagsContainer.innerHTML = '';
            } else {
                namesInput.value = selectedResponsibles.map(u => u.name).join(', ');
                idsInput.value = selectedResponsibles.map(u => u.id).join(',');
                
                tagsContainer.innerHTML = '';
                selectedResponsibles.forEach(user => {
                    const tag = document.createElement('div');
                    tag.className = 'selected-user-tag';
                    tag.innerHTML = `
                        <span>${user.name}</span>
                        <span class="remove-btn" onclick="removeResponsible(${user.id})">√ó</span>
                    `;
                    tagsContainer.appendChild(tag);
                });
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
        function removeResponsible(userId) {
            selectedResponsibles = selectedResponsibles.filter(u => u.id !== userId);
            updateResponsiblesDisplay();
        }
        
        // –¢–µ–∫—É—â–∏–π —Ç–∏–ø –≤—ã–±–æ—Ä–∞ (creator –∏–ª–∏ responsible)
        let currentUserSelectType = null;
        let currentUserSelectLabel = null;
        
        // –ü–æ–∏—Å–∫ –∏ –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –ø–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞ - –æ–¥–∏–Ω)
        function searchAndSelectUser(type, label) {
            if (usersList.length === 0) {
                tg.showAlert('–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                return;
            }
            
            currentUserSelectType = type;
            currentUserSelectLabel = label;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.getElementById('modalTitle').textContent = `–í—ã–±–æ—Ä ${label}`;
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
            document.getElementById('modalSearch').value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            renderUsersList(usersList);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('userModal').classList.add('show');
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
            setTimeout(() => {
                document.getElementById('modalSearch').focus();
            }, 100);
        }
        
        // –ü–æ–∏—Å–∫ –∏ –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π - –Ω–µ—Å–∫–æ–ª—å–∫–æ)
        function searchAndSelectUsers(type, label) {
            if (usersList.length === 0) {
                tg.showAlert('–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                return;
            }
            
            currentUserSelectType = type;
            currentUserSelectLabel = label;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.getElementById('modalTitle').textContent = `–í—ã–±–æ—Ä ${label}`;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –º–æ–¥–∞–ª–∫–µ –∏–∑ —Ç–µ–∫—É—â–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
            selectedUsersInModal = new Set(selectedResponsibles.map(u => u.id.toString()));
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
            document.getElementById('modalSearch').value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            renderUsersListMultiSelect(usersList);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('userModal').classList.add('show');
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
            setTimeout(() => {
                document.getElementById('modalSearch').focus();
            }, 100);
        }
        
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
            currentUserSelectType = null;
            currentUserSelectLabel = null;
            selectedUsersInModal.clear();
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä)
        function renderUsersList(users) {
            const listContainer = document.getElementById('modalUsersList');
            listContainer.innerHTML = '';
            
            if (users.length === 0) {
                listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--tg-theme-hint-color, #999999);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'modal-user-item';
                userItem.innerHTML = `
                    <div class="modal-user-name">${user.name}</div>
                    <div class="modal-user-id">ID: ${user.id}</div>
                `;
                userItem.onclick = () => selectUser(user);
                listContainer.appendChild(userItem);
            });
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä)
        function renderUsersListMultiSelect(users) {
            const listContainer = document.getElementById('modalUsersList');
            listContainer.innerHTML = '';
            
            if (users.length === 0) {
                listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--tg-theme-hint-color, #999999);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            users.forEach(user => {
                const isSelected = selectedUsersInModal.has(user.id.toString());
                const userItem = document.createElement('div');
                userItem.className = `modal-user-item ${isSelected ? 'selected' : ''}`;
                userItem.innerHTML = `
                    <div class="modal-user-content">
                        <div class="checkbox"></div>
                        <div>
                            <div class="modal-user-name">${user.name}</div>
                            <div class="modal-user-id">ID: ${user.id}</div>
                        </div>
                    </div>
                `;
                userItem.onclick = () => toggleUserSelection(user);
                listContainer.appendChild(userItem);
            });
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function toggleUserSelection(user) {
            const userId = user.id.toString();
            if (selectedUsersInModal.has(userId)) {
                selectedUsersInModal.delete(userId);
            } else {
                selectedUsersInModal.add(userId);
            }
            
            // –°—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if (currentUserSelectType === 'responsible') {
                selectedResponsibles = usersList
                    .filter(u => selectedUsersInModal.has(u.id.toString()))
                    .map(u => ({ id: u.id, name: u.name }));
                updateResponsiblesDisplay();
            }
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
            const searchText = document.getElementById('modalSearch').value.trim().toLowerCase();
            let usersToShow = usersList;
            if (searchText) {
                usersToShow = usersList.filter(u => 
                    u.name.toLowerCase().includes(searchText) || 
                    u.id.toString().includes(searchText)
                );
            }
            renderUsersListMultiSelect(usersToShow);
        }
        
        // –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function selectUser(user) {
            if (!currentUserSelectType || !user) return;
            
            if (currentUserSelectType === 'creator') {
                document.getElementById('creatorName').value = user.name;
                document.getElementById('creatorId').value = user.id;
            } else {
                document.getElementById('responsibleName').value = user.name;
                document.getElementById('responsibleId').value = user.id;
            }
            
            closeUserModal();
            tg.showAlert(`‚úÖ –í—ã–±—Ä–∞–Ω ${currentUserSelectLabel}: ${user.name}`);
        }
        
        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –≤–≤–æ–¥–µ
        document.getElementById('modalSearch').addEventListener('input', (e) => {
            const searchText = e.target.value.trim().toLowerCase();
            
            if (!searchText) {
                if (currentUserSelectType === 'responsible') {
                    renderUsersListMultiSelect(usersList);
                } else {
                    renderUsersList(usersList);
                }
                return;
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID
            const filtered = usersList.filter(u => 
                u.name.toLowerCase().includes(searchText) || 
                u.id.toString().includes(searchText)
            );
            
            if (currentUserSelectType === 'responsible') {
                renderUsersListMultiSelect(filtered);
            } else {
                renderUsersList(filtered);
            }
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
        document.getElementById('userModal').addEventListener('click', (e) => {
            if (e.target.id === 'userModal') {
                closeUserModal();
            }
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –ú–°–ö
        // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç Date, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –ú–°–ö –≤—Ä–µ–º—è
        function getMoscowTime() {
            const now = new Date();
            // –ü–æ–ª—É—á–∞–µ–º UTC –≤—Ä–µ–º—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
            const utcTime = now.getTime();
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –ú–°–ö –≤—Ä–µ–º—è (UTC+3)
            // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ú–°–ö –≤—Ä–µ–º—è –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
            const moscowOffset = 3 * 60 * 60 * 1000; // 3 —á–∞—Å–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
            const moscowTime = new Date(utcTime + moscowOffset);
            return moscowTime;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ú–°–ö –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ UTC –¥–∞—Ç—ã
        function getMoscowTimeFromUTC(utcDate) {
            const moscowOffset = 3 * 60 * 60 * 1000; // 3 —á–∞—Å–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
            return new Date(utcDate.getTime() + moscowOffset);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –¥–ª—è input[type="datetime-local"]
        // datetime-local –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –±—Ä–∞—É–∑–µ—Ä–∞
        function formatLocalDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ datetime-local –∑–Ω–∞—á–µ–Ω–∏—è
        // datetime-local –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä–∞
        // –ù–æ –º—ã –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º –µ–≥–æ –∫–∞–∫ –ú–°–ö –≤—Ä–µ–º—è –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ UTC
        function parseLocalDateTimeToUTC(dateTimeString) {
            // –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É —Ñ–æ—Ä–º–∞—Ç–∞ YYYY-MM-DDTHH:mm
            const [datePart, timePart] = dateTimeString.split('T');
            const [year, month, day] = datePart.split('-').map(Number);
            const [hours, minutes] = timePart.split(':').map(Number);
            
            // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É—è –≤–≤–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∫–∞–∫ –ú–°–ö –≤—Ä–µ–º—è
            // –î–ª—è —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–µ–º UTC –¥–∞—Ç—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –≤ –ú–°–ö –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω—É–∂–Ω–æ–µ –≤—Ä–µ–º—è
            // –ú–°–ö = UTC+3, –ø–æ—ç—Ç–æ–º—É UTC = –ú–°–ö - 3 —á–∞—Å–∞
            // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –≤ UTC, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ 3 —á–∞—Å–æ–≤ –¥–∞—Å—Ç –Ω—É–∂–Ω–æ–µ –ú–°–ö –≤—Ä–µ–º—è
            const mskDate = new Date(Date.UTC(year, month - 1, day, hours, minutes));
            // –í—ã—á–∏—Ç–∞–µ–º 3 —á–∞—Å–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ UTC –≤—Ä–µ–º—è
            const utcDate = new Date(mskDate.getTime() - (3 * 60 * 60 * 1000));
            
            return utcDate;
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–¥–ª–∞–π–Ω–∞ —á–µ—Ä–µ–∑ –∑–∞–≥–æ—Ç–æ–≤–∫—É (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π)
        function setDeadlineShortcut(days) {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –ú–°–ö –≤—Ä–µ–º—è
            const nowMsk = getMoscowTime();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ –∫ –ú–°–ö –≤—Ä–µ–º–µ–Ω–∏
            const deadlineMsk = new Date(nowMsk);
            deadlineMsk.setDate(nowMsk.getDate() + days);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ 18:00 –ú–°–ö (–∫–æ–Ω–µ—Ü —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è)
            deadlineMsk.setHours(18, 0, 0, 0);
            
            // –î–ª—è datetime-local –Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –ú–°–ö –≤—Ä–µ–º—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä–∞
            // datetime-local —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –±—Ä–∞—É–∑–µ—Ä–∞
            // –ü–æ–ª—É—á–∞–µ–º UTC –≤—Ä–µ–º—è –∏–∑ –ú–°–ö –≤—Ä–µ–º–µ–Ω–∏
            const mskOffset = 3 * 60 * 60 * 1000; // 3 —á–∞—Å–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
            const utcTime = deadlineMsk.getTime() - mskOffset;
            const localDate = new Date(utcTime);
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è input[type="datetime-local"]
            const formattedDate = formatLocalDateTime(localDate);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–ª–µ
            document.getElementById('deadline').value = formattedDate;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –ú–°–ö –≤—Ä–µ–º–µ–Ω–µ–º
            const dayLabels = {
                1: '1 –¥–µ–Ω—å',
                3: '3 –¥–Ω—è',
                7: '7 –¥–Ω–µ–π',
                15: '15 –¥–Ω–µ–π',
                30: '–º–µ—Å—è—Ü'
            };
            const day = String(deadlineMsk.getDate()).padStart(2, '0');
            const month = String(deadlineMsk.getMonth() + 1).padStart(2, '0');
            const year = deadlineMsk.getFullYear();
            const hours = String(deadlineMsk.getHours()).padStart(2, '0');
            const minutes = String(deadlineMsk.getMinutes()).padStart(2, '0');
            tg.showAlert(`‚úÖ –°—Ä–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: —á–µ—Ä–µ–∑ ${dayLabels[days] || days + ' –¥–Ω–µ–π'} (${day}.${month}.${year} –≤ ${hours}:${minutes} –ú–°–ö)`);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
            
            const responsibleIds = document.getElementById('responsibleIds').value;
            if (!responsibleIds) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è');
                submitBtn.disabled = false;
                submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É';
                return;
            }
            
            const departmentId = document.getElementById('departmentId').value;
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É ID –≤ –º–∞—Å—Å–∏–≤
            const responsibleIdsArray = responsibleIds.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            
            if (responsibleIdsArray.length === 0) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è');
                submitBtn.disabled = false;
                submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É';
                return;
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º deadline –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
            // datetime-local –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (–ú–°–ö)
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ú–°–ö –≤ UTC –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            let deadlineValue = document.getElementById('deadline').value;
            if (deadlineValue) {
                // –ü–∞—Ä—Å–∏–º –≤–≤–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ–µ (–ú–°–ö) –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ UTC
                const utcDate = parseLocalDateTimeToUTC(deadlineValue);
                deadlineValue = utcDate.toISOString().slice(0, 19).replace('T', ' ');
            }
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            let descriptionValue = document.getElementById('description').value;
            if (sessionData.original_message_text) {
                if (descriptionValue) {
                    descriptionValue = sessionData.original_message_text + '\n\n' + descriptionValue;
                } else {
                    descriptionValue = sessionData.original_message_text;
                }
            }
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º JSON –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                const formData = {
                    token: token,
                    title: document.getElementById('taskTitle').value,
                    creator_id: parseInt(document.getElementById('creatorId').value),
                    responsible_ids: responsibleIdsArray,
                    deadline: deadlineValue || null,
                    description: descriptionValue || '',
                    department_id: departmentId ? parseInt(departmentId) : null
                };
                
                const requestBody = JSON.stringify(formData);
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                const response = await fetch(getApiUrl('/api/miniapp/create-task'), {
                    method: 'POST',
                    headers: headers,
                    body: requestBody
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                }
                
                // –£—Å–ø–µ—Ö
                document.getElementById('taskForm').style.display = 'none';
                document.getElementById('success').classList.add('show');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º Mini App —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    tg.close();
                }, 2000);
                
            } catch (error) {
                showError(error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É';
            }
        });
        
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadSession();
    </script>
</body>
</html>
