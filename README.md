# Telegram бот для Битрикс24

Telegram бот-мини приложение для создания задач в Битрикс24 через @ упоминания.

## Возможности

- ✅ Создание задач в Битрикс24 через Telegram бота
- ✅ Пошаговый диалог для уточнения деталей задачи
- ✅ Назначение нескольких ответственных через запятую
- ✅ Установка срока выполнения задачи
- ✅ Добавление описания и файлов к задаче
- ✅ Автоматическое определение создателя задачи по Telegram аккаунту

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd bitrix-24-bot-muglerest-fr
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

4. Заполните переменные окружения в файле `.env`:
```env
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
BITRIX24_DOMAIN=your-domain.bitrix24.ru
BITRIX24_WEBHOOK_TOKEN=your_webhook_token_here
BITRIX24_USER_ID=your_user_id_here
```

## Настройка

### 1. Создание Telegram бота

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте полученный токен в переменную `TELEGRAM_BOT_TOKEN`

### 2. Настройка Битрикс24

1. Войдите в ваш портал Битрикс24
2. Перейдите в **Настройки** → **Приложения** → **Входящий вебхук**
3. Создайте новый входящий вебхук с правами:
   - `task` (задачи)
   - `user` (пользователи)
4. Скопируйте URL вебхука и извлеките из него:
   - Домен (например, `your-domain.bitrix24.ru`)
   - Токен вебхука (последняя часть URL после `/rest/`)
5. Заполните переменные `BITRIX24_DOMAIN` и `BITRIX24_WEBHOOK_TOKEN`

### 3. Получение User ID в Битрикс24

1. Войдите в Битрикс24
2. Перейдите в **Настройки** → **Пользователи**
3. Откройте профиль нужного пользователя
4. В URL будет ID пользователя (например, `/company/personal/user/123/`)
5. Используйте этот ID для переменной `BITRIX24_USER_ID`

## Использование

### Запуск бота

```bash
python bot.py
```

### Связывание пользователей

Перед использованием необходимо связать ваш Telegram аккаунт с ID пользователя Битрикс24:

```
/link bitrix_user_id
```

Пример:
```
/link 123
```

Для поиска пользователей по имени можно также связать Telegram username:

```
/link_username @username bitrix_user_id
```

Пример:
```
/link_username @ivanov 123
```

### Создание задачи

1. Упомяните бота в сообщении с текстом задачи:
   ```
   @bitmugle, Зум по встрече с партнерами
   ```

2. Бот задаст вам вопросы:
   - **На кого задача?** (можно указать несколько человек через запятую)
     - Пример: `Иван Иванов, Петр Петров`
   
   - **Какой срок?** (формат: дд.мм.гг чч:мм)
     - Пример: `25.12.24 15:30`
   
   - **Введите описание** (можно пропустить, отправив `-` или `пропустить`)
   
   - **Прикрепите файлы** (можно пропустить, отправив `-`)

3. После ответа на все вопросы бот создаст задачу в Битрикс24.

### Отмена создания задачи

В любой момент можно отменить создание задачи командой:
```
/cancel
```

## Деплой на Railway

Проект готов к деплою на Railway без использования командной строки и .env файлов.

### Шаги для деплоя:

1. **Подключите репозиторий к Railway:**
   - Зайдите на [Railway](https://railway.app)
   - Создайте новый проект
   - Подключите ваш GitHub репозиторий

2. **Настройте переменные окружения в Railway:**
   - В интерфейсе Railway перейдите в раздел **Variables**
   - Добавьте следующие переменные:
     - `TELEGRAM_BOT_TOKEN` - токен вашего Telegram бота
     - `BITRIX24_DOMAIN` - домен Битрикс24 (например, `your-domain.bitrix24.ru`)
     - `BITRIX24_WEBHOOK_TOKEN` - токен вебхука Битрикс24
     - `BITRIX24_USER_ID` - ваш ID пользователя в Битрикс24 (опционально, для дефолтного создателя)
     - `WEBHOOK_URL` - URL вашего приложения на Railway (Railway автоматически предоставляет переменную `RAILWAY_PUBLIC_DOMAIN`, но можно использовать полный URL)

3. **Настройте webhook для Telegram:**
   - После деплоя Railway предоставит публичный URL вашего приложения
   - Добавьте переменную `WEBHOOK_URL` в Railway со значением `https://${{RAILWAY_PUBLIC_DOMAIN}}`
     (Railway автоматически подставит ваш домен)
   - Или установите webhook вручную через API Telegram:
     ```
     https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook?url=https://<YOUR_RAILWAY_DOMAIN>/<YOUR_BOT_TOKEN>
     ```
   - Бот автоматически настроит webhook при запуске, если установлены `PORT` и `WEBHOOK_URL`

4. **Railway автоматически:**
   - Определит Python из `runtime.txt`
   - Установит зависимости из `requirements.txt`
   - Запустит приложение через `Procfile`

### Примечания:

- Railway автоматически устанавливает переменную `PORT` - бот использует её для webhook
- Если `PORT` установлен, но `WEBHOOK_URL` не найден, бот попытается использовать `RAILWAY_PUBLIC_DOMAIN`
- Если `PORT` не установлен, бот будет работать в режиме polling (для локальной разработки)
- Все переменные окружения настраиваются через интерфейс Railway, файл `.env` не требуется
- После первого деплоя проверьте логи Railway, чтобы убедиться, что webhook установлен корректно

## Структура проекта

```
.
├── bot.py                 # Основной файл Telegram бота
├── bitrix24_client.py     # Клиент для работы с API Битрикс24
├── requirements.txt       # Зависимости Python
├── Procfile              # Конфигурация для Railway
├── runtime.txt          # Версия Python для Railway
├── set_webhook.py        # Скрипт для установки webhook (опционально)
├── .env.example          # Пример файла конфигурации (для локальной разработки)
├── .gitignore            # Игнорируемые файлы
└── README.md             # Документация
```

## API Битрикс24

Бот использует следующие методы API Битрикс24:

- `tasks.task.add` - создание задачи
- `user.get` - получение информации о пользователе
- `user.search` - поиск пользователей

## Разработка

### Добавление новых функций

1. Расширьте класс `Bitrix24Client` в `bitrix24_client.py` для новых методов API
2. Добавьте новые обработчики в `bot.py`
3. Обновите документацию

### Хранение соответствий пользователей

В текущей версии соответствия Telegram username → Bitrix24 User ID хранятся в памяти (`USER_MAPPING`). Для продакшена рекомендуется использовать базу данных (например, SQLite или PostgreSQL).

## Лицензия

MIT
