# Анализ вебхуков от Bitrix24

Система позволяет читать и анализировать данные, которые отправляет Bitrix24 через исходящий вебхук.

## Возможности

1. **Просмотр последних вебхуков** - список всех полученных вебхуков с информацией о типе события и времени получения
2. **Детальный просмотр вебхука** - полная информация о конкретном вебхуке, включая все данные в формате JSON
3. **Фильтрация по типу события** - просмотр вебхуков определенного типа (например, только ONTASKUPDATE)

## Команды

### `/webhooks [тип] [лимит]`

Показывает список последних вебхуков от Bitrix24.

**Параметры:**
- `тип` (опционально) - фильтр по типу события (например, `ONTASKUPDATE`, `ONTASKCOMMENTADD`, `ONUSERUPDATE`)
- `лимит` (опционально) - количество вебхуков для отображения (по умолчанию 10, максимум 50)

**Примеры использования:**
```
/webhooks                    # Последние 10 вебхуков
/webhooks 20                 # Последние 20 вебхуков
/webhooks ONTASKUPDATE       # Все вебхуки типа ONTASKUPDATE
/webhooks ONTASKCOMMENTADD 5 # Последние 5 вебхуков типа ONTASKCOMMENTADD
```

**Вывод:**
- Список вебхуков с ID, типом события, временем получения и Handler ID
- Для каждого вебхука можно получить детальную информацию командой `/webhook <id>`

### `/webhook <id>`

Показывает детальную информацию о конкретном вебхуке.

**Параметры:**
- `id` (обязательно) - ID вебхука из списка `/webhooks`

**Примеры использования:**
```
/webhook 123
```

**Вывод:**
- Тип события
- Handler ID
- Время получения
- Timestamp события
- Домен Bitrix24
- Member ID
- Структурированные данные (FIELDS_AFTER, FIELDS_BEFORE)
- Полный JSON всех данных вебхука

## Типы событий

Bitrix24 отправляет следующие типы событий:

### События задач:
- `ONTASKADD` - создание задачи
- `ONTASKUPDATE` - обновление задачи (изменение статуса, дедлайна и т.д.)
- `ONTASKDELETE` - удаление задачи

### События комментариев:
- `ONTASKCOMMENTADD` - добавление комментария к задаче
- `ONTASKCOMMENTUPDATE` - обновление комментария
- `ONTASKCOMMENTDELETE` - удаление комментария

### События пользователей:
- `ONUSERADD` - добавление пользователя
- `ONUSERUPDATE` - обновление пользователя (включая изменение Telegram ID)

## Структура данных вебхука

Каждый вебхук содержит:

```json
{
  "event": "ТИП_СОБЫТИЯ",
  "event_handler_id": "ID_ОБРАБОТЧИКА",
  "data": {
    "FIELDS_BEFORE": {...},  // Данные до изменения (для UPDATE/DELETE)
    "FIELDS_AFTER": {...},    // Данные после изменения (для ADD/UPDATE)
    "IS_ACCESSIBLE_BEFORE": "...",
    "IS_ACCESSIBLE_AFTER": "..."
  },
  "ts": "TIMESTAMP",
  "auth": {
    "domain": "домен.bitrix24.ru",
    "client_endpoint": "https://домен.bitrix24.ru/rest/",
    "server_endpoint": "https://oauth.bitrix24.tech/rest/",
    "member_id": "идентификатор_участника",
    "application_token": "токен_приложения"
  }
}
```

## Где хранятся данные

Все данные вебхуков автоматически сохраняются в таблицу `webhook_events` в PostgreSQL базе данных. Это позволяет:

1. Просматривать историю всех вебхуков
2. Анализировать данные в любое время
3. Отслеживать изменения в Bitrix24

## Требования

Для работы команд `/webhooks` и `/webhook` требуется:

1. **PostgreSQL база данных** - данные вебхуков сохраняются в БД
2. **Настроенный исходящий вебхук** - Bitrix24 должен отправлять вебхуки на ваш сервер

## Настройка исходящего вебхука

Для получения вебхуков от Bitrix24:

1. Откройте Bitrix24 → Настройки → Разработчикам → Исходящий вебхук
2. Создайте новый вебхук или используйте существующий
3. Укажите URL вашего сервера (например, `https://your-domain.com/api/bitrix/webhook`)
4. Выберите события для отслеживания:
   - События задач: `ONTASKADD`, `ONTASKUPDATE`, `ONTASKDELETE`
   - События комментариев: `ONTASKCOMMENTADD`, `ONTASKCOMMENTUPDATE`, `ONTASKCOMMENTDELETE`
   - События пользователей: `ONUSERADD`, `ONUSERUPDATE`
5. Сохраните токен вебхука в переменную окружения `BITRIX24_OUTGOING_WEBHOOK_TOKEN`

## Примеры использования

### Просмотр всех вебхуков за последний час

```
/webhooks 50
```

### Поиск всех обновлений задач

```
/webhooks ONTASKUPDATE
```

### Анализ конкретного вебхука

1. Получите список вебхуков: `/webhooks`
2. Найдите нужный вебхук по типу события и времени
3. Используйте ID для просмотра деталей: `/webhook 123`

### Отслеживание комментариев к задачам

```
/webhooks ONTASKCOMMENTADD 20
```

## Дополнительная информация

- Все вебхуки логируются в консоль с подробной информацией
- Данные сохраняются автоматически при получении вебхука
- История вебхуков хранится в базе данных и доступна для анализа

## Связанные документы

- [`WEBHOOK_DATA_STRUCTURE.md`](WEBHOOK_DATA_STRUCTURE.md) - подробная структура данных вебхука
- [`BITRIX_OUTGOING_WEBHOOK.md`](BITRIX_OUTGOING_WEBHOOK.md) - настройка исходящего вебхука
- [`TASK_NOTIFICATIONS.md`](TASK_NOTIFICATIONS.md) - система уведомлений о задачах
