# Голосовое управление задачами

## Обзор

Бот теперь поддерживает создание задач в Bitrix24 с помощью голосовых сообщений с использованием технологии распознавания речи OpenAI Whisper.

## Функциональность

### Основные возможности

1. **Распознавание речи** - Голосовые сообщения преобразуются в текст с помощью OpenAI Whisper
2. **Извлечение данных задачи** - Автоматическое определение:
   - Заголовка задачи
   - Ответственных лиц
   - Дедлайна
   - Описания задачи
3. **Уточняющие вопросы** - При низкой уверенности распознавания бот задает уточняющие вопросы
4. **Подтверждение создания** - Пользователь может подтвердить создание задачи перед отправкой в Bitrix24

### Как использовать

1. Запишите голосовое сообщение с описанием задачи
2. Отправьте его боту в личном сообщении или группе
3. Бот обработает сообщение и покажет распознанные данные
4. Если уверенность распознавания высокая, используйте `/confirm_voice` для создания задачи
5. Если нужны уточнения, ответьте на вопросы бота или используйте `/create` для ручного ввода

## Примеры голосовых команд

### Простая задача
> "Создать задачу подготовить отчет по продажам до пятницы"

**Распознавание:**
- Заголовок: "Подготовить отчет по продажам"
- Дедлайн: ближайшая пятница
- Ответственные: потребуется уточнение

### Задача с ответственными
> "Поручить Ивану и Марии провести анализ конкурентов до 15 марта"

**Распознавание:**
- Заголовок: "Провести анализ конкурентов"
- Ответственные: Иван, Мария
- Дедлайн: 15 марта

### Срочная задача
> "Сегодня срочно исправить ошибку на сайте ответственный Петр"

**Распознавание:**
- Заголовок: "Исправить ошибку на сайте"
- Ответственные: Петр
- Дедлайн: сегодня

## Настройка

### Требования

1. **OpenAI API Key** - необходим для работы Whisper
2. **Дополнительные зависимости** - установятся автоматически с requirements.txt

### Установка API ключа OpenAI

1. Перейдите на https://platform.openai.com/api-keys
2. Создайте новый API ключ
3. Добавьте ключ в переменные окружения:
   ```
   OPENAI_API_KEY=sk-your-api-key-here
   ```

### Установка зависимостей

```bash
pip install -r requirements.txt
```

Новые зависимости:
- `openai>=1.0.0` - для работы с OpenAI API
- `pydub>=0.25.1` - для конвертации аудио форматов

## Алгоритм работы

### 1. Обработка голосового сообщения

```
Голосовое сообщение → Скачивание → Конвертация в MP3 → Распознавание речи (Whisper) → Текст
```

### 2. Парсинг текста

```
Текст → Извлечение сущностей → Анализ уверенности → Формирование данных задачи
```

### 3. Логика уточнений

```
Уверенность < 50% → Уточняющие вопросы
Уверенность >= 50% → Предпросмотр и подтверждение
```

## Команды

### `/confirm_voice`
Подтверждает создание задачи из последнего голосового сообщения.

### `/create`
Создает задачу в ручном режиме (стандартная функциональность).

## Особенности реализации

### Распознавание ответственных

Бот ищет ответственных по паттернам:
- "Ответственный: Имя"
- "Поручить Имя"
- "Для Имя сделать"
- "Имя должен сделать"

### Распознавание дат

Поддерживаемые форматы:
- "До 15 марта"
- "Сегодня", "завтра", "послезавтра"
- "Через 3 дня"
- "На следующей неделе"

### Уровень уверенности

Расчет уверенности основан на:
- Наличие заголовка (30%)
- Наличие ответственных (30%)
- Наличие дедлайна (20%)
- Дополнительные факторы (20%)

## Обработка ошибок

### Распространенные проблемы

1. **Неразборчивое сообщение** - бот предложит повторить или использовать текст
2. **Не найдены ответственные** - задача будет назначена на отправителя
3. **Непонятная дата** - бот попросит уточнить дедлайн
4. **Проблемы с OpenAI API** - бот сообщит об ошибке и предложит попробовать позже

### Логирование

Все операции с голосовыми сообщениями логируются:
- Успешное распознавание
- Ошибки обработки
- Уровень уверенности
- Уточняющие вопросы

## Безопасность

### Конфиденциальность

- Временные аудиофайлы удаляются сразу после обработки
- Распознанный текст не хранится в логах в открытом виде
- API ключ OpenAI хранится в переменных окружения

### Рекомендации

- Используйте отдельный API ключ для бота
- Ограничьте права API ключа только необходимыми функциями
- Регулярно проверьте использование API в панели OpenAI

## Советы по использованию

### Для лучшего распознавания

1. **Говорите четко** - избегайте слишком быстрой речи
2. **Используйте структуру** - упомяните ответственных и дедлайн явно
3. **Избегайте шума** - записывайте в тихом месте
4. **Короткие сообщения** - до 30 секунд для лучшего качества

### Пример хорошей команды

> "Создать задачу обновить документацию по API до 20 декабря ответственный Алексей"

### Пример плохой команды

> "мнадо сделать чтото с сайтом скоро"

## Интеграция с существующей функциональностью

Голосовое управление полностью интегрировано с существующим функционалом бота:

- Использует ту же систему авторизации в Bitrix24
- Работает с теми же маппингами пользователей и отделов
- Создает задачи в том же формате с теми же полями
- Поддерживает все существующие уведомления

## Тестирование

### Тестовый сценарий

1. Отправьте голосовое сообщение: "Тестовая задача для проверки голосового управления"
2. Проверьте правильность распознавания текста
3. Используйте `/confirm_voice` для создания задачи
4. Убедитесь, что задача появилась в Bitrix24

### Отладка

При проблемах проверьте:
- Наличие и правильность `OPENAI_API_KEY`
- Установку зависимостей (`pip install openai pydub`)
- Логи бота на предмет ошибок
- Доступность OpenAI API

## Будущие улучшения

Планируемые улучшения:
- Поддержка нескольких языков
- Распознавание тона и приоритета задачи
- Интеграция с другими моделями AI для анализа задач
- Голосовые подтверждения и уточнения
